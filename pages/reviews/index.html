<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>レビューを書く</title>
    <link rel="stylesheet" href="../../css/pages/reviews/style.css">

    <script>
        const API_BASE = "http://localhost:8787";
        const USER_ID = "demo-user-001"; // 実際はログイン情報から取得

        function setRating(r) {
            document.getElementById("rating").value = r;

            for (let i = 1; i <= 5; i++) {
                document.getElementById("star" + i).textContent = i <= r ? "★" : "☆";
            }
        }

        // レビュー送信処理
        async function submitReview(event) {
            event.preventDefault();

            const gameId = document.getElementById("game-id").value;
            const rating = parseInt(document.getElementById("rating").value);
            const comment = document.getElementById("comment").value;

            if (!rating || rating < 1 || rating > 5) {
                alert("評価を選択してください（1〜5）");
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/reviews`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        game_id: Number(gameId),
                        user_id: USER_ID,
                        rating: rating,
                        comment: comment
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    alert(`投稿失敗: ${result.error}`);
                    return;
                }

                alert("レビューを投稿しました！");
                // 必要なら別ページへ遷移
                // location.href = "/pages/games/detail.html?id=" + gameId;

            } catch (error) {
                console.error(error);
                alert("エラーが発生しました");
            }
        }
    </script>
</head>

<body>

<div class="container">

    <div class="title-box">
        <h2>レビューを書く</h2>
        <p>ゲームの評価とコメントを入力してください。</p>
    </div>

    <div class="content">

        <div class="left">
            <img src="https://images.unsplash.com/photo-1529333166437-7750a6dd5a70" alt="">
        </div>

        <div class="right">
            <h3>レビュー投稿フォーム</h3>

            <!-- ★ PHP送信をやめて onsubmit を使用 -->
            <form onsubmit="submitReview(event)">

                <!-- 実際は URL パラメータなどから入れる -->
                <label>ゲームID</label>
                <input type="number" id="game-id" value="1" required>

                <label>評価（1〜5）</label>
                <div class="stars">
                    <span id="star1" onclick="setRating(1)">☆</span>
                    <span id="star2" onclick="setRating(2)">☆</span>
                    <span id="star3" onclick="setRating(3)">☆</span>
                    <span id="star4" onclick="setRating(4)">☆</span>
                    <span id="star5" onclick="setRating(5)">☆</span>
                </div>
                <input type="hidden" id="rating" value="0">

                <label>コメント</label>
                <textarea id="comment" rows="5" required></textarea>

                <button type="submit">送信する</button>

            </form>
        </div>

    </div>
</div>

</body>
</html>
